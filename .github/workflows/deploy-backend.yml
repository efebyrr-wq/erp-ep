name: Deploy Backend to Elastic Beanstalk

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # Allow manual trigger

env:
  AWS_REGION: eu-north-1
  EB_APPLICATION_NAME: deployment-erp
  EB_ENVIRONMENT_NAME: Deployment-erp-env-v4
  S3_BUCKET: elasticbeanstalk-eu-north-1-717036606024

jobs:
  deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          echo "üì¶ Installing dependencies..."
          npm install
          echo "‚úÖ Dependencies installed"

      - name: Build backend
        working-directory: ./backend
        run: |
          echo "üî® Building backend..."
          npm run build
          echo "‚úÖ Build completed"
          ls -la dist/ || echo "‚ö†Ô∏è dist/ directory check"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create deployment package
        working-directory: ./backend
        run: |
          echo "üì¶ Creating deployment package..."
          # Check if dist directory exists
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: dist/ directory not found!"
            exit 1
          fi
          
          # Check if package.json exists
          if [ ! -f "package.json" ]; then
            echo "‚ùå Error: package.json not found!"
            exit 1
          fi
          
          # Include package-lock.json if it exists, otherwise just package.json
          if [ -f package-lock.json ]; then
            echo "üìÑ Including package-lock.json"
            zip -r erp-backend-deploy.zip dist/ package.json package-lock.json \
              -x "*.map" "*.tsbuildinfo" "node_modules/*"
          else
            echo "üìÑ Using package.json only"
            zip -r erp-backend-deploy.zip dist/ package.json \
              -x "*.map" "*.tsbuildinfo" "node_modules/*"
          fi
          
          # Verify zip was created
          if [ ! -f "erp-backend-deploy.zip" ]; then
            echo "‚ùå Error: Failed to create deployment package!"
            exit 1
          fi
          
          echo "‚úÖ Deployment package created: $(ls -lh erp-backend-deploy.zip)"

      - name: Upload to S3
        run: |
          echo "üì§ Uploading to S3..."
          S3_KEY="erp-backend-deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}.zip"
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV
          
          # Verify zip exists before uploading
          if [ ! -f "backend/erp-backend-deploy.zip" ]; then
            echo "‚ùå Error: Deployment package not found!"
            exit 1
          fi
          
          aws s3 cp backend/erp-backend-deploy.zip \
            s3://${{ env.S3_BUCKET }}/$S3_KEY \
            --region ${{ env.AWS_REGION }}
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Error: Failed to upload to S3!"
            exit 1
          fi
          
          echo "‚úÖ Uploaded to S3: $S3_KEY"

      - name: Create EB application version
        run: |
          echo "üì¶ Creating EB application version..."
          VERSION_LABEL="deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          echo "VERSION_LABEL=$VERSION_LABEL" >> $GITHUB_ENV
          
          aws elasticbeanstalk create-application-version \
            --region ${{ env.AWS_REGION }} \
            --application-name "${{ env.EB_APPLICATION_NAME }}" \
            --version-label "$VERSION_LABEL" \
            --source-bundle S3Bucket="${{ env.S3_BUCKET }}",S3Key="${{ env.S3_KEY }}" \
            --description "Deployment from GitHub - ${GITHUB_SHA:0:7} - ${GITHUB_ACTOR}" \
            --output text --query 'ApplicationVersion.VersionLabel'
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Error: Failed to create EB application version!"
            exit 1
          fi
          
          echo "‚úÖ Created version: $VERSION_LABEL"

      - name: Deploy to Elastic Beanstalk
        run: |
          echo "üöÄ Deploying to Elastic Beanstalk..."
          aws elasticbeanstalk update-environment \
            --region ${{ env.AWS_REGION }} \
            --environment-name "${{ env.EB_ENVIRONMENT_NAME }}" \
            --version-label "${{ env.VERSION_LABEL }}" \
            --output text --query 'EnvironmentId'
          
          if [ $? -ne 0 ]; then
            echo "‚ùå Error: Failed to deploy to Elastic Beanstalk!"
            exit 1
          fi
          
          echo "‚úÖ Deployment initiated"

      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for deployment to complete..."
          aws elasticbeanstalk wait environment-updated \
            --region ${{ env.AWS_REGION }} \
            --environment-names "${{ env.EB_ENVIRONMENT_NAME }}" \
            || echo "‚ö†Ô∏è Deployment may still be in progress. Check AWS Console."

      - name: Get deployment status
        run: |
          aws elasticbeanstalk describe-environments \
            --region ${{ env.AWS_REGION }} \
            --environment-names "${{ env.EB_ENVIRONMENT_NAME }}" \
            --query 'Environments[0].[Status,Health,VersionLabel]' \
            --output table

